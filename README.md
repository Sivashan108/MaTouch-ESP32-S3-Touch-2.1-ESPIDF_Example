
# MaTouch ESP32‑S3 Touch 2.1″ ESP‑IDF Example

> **Note:** This README was generated by an AI assistant to help document the project

This repository ports the **Makerfabs MaTouch ESP32‑S3 2.1″ IPS display with capacitive touch (ST7701)** Arduino example to the **Espressif IoT Development Framework (ESP‑IDF)**.  It demonstrates how to drive the 480×480 ST7701 LCD and CST826 touch controller using native ESP‑IDF drivers instead of the Arduino framework.

## Background

The original Makerfabs project provides a set of Arduino sketches for testing the MaTouch board, including display and touch demonstrations, SPIFFS file browsing, and stepper‑motor control.  This repository adapts those examples to the ESP‑IDF environment to take advantage of native FreeRTOS tasks, build tooling and peripheral APIs.  By using ESP‑IDF you gain finer control over timing, memory management and the ability to integrate the display into larger, multi‑tasking applications.

For reference, see the original Arduino project here:

<https://github.com/Makerfabs/MaTouch-ESP32-S3-Rotary-IPS-Display-with-Touch-2.1-ST7701>

## Hardware overview

| Component              | Description                                     |
|-----------------------|-------------------------------------------------|
| **MCU**               | ESP32‑S3 dual‑core microcontroller              |
| **Display**           | 2.1″ 480×480 IPS TFT with ST7701 driver         |
| **Touch controller**  | Capacitive touch panel driven by CST826         |
| **Wireless**          | Wi‑Fi 802.11b/g/n and Bluetooth 5.0             |
| **USB interface**     | Type‑C port with native USB peripheral          |
| **PSRAM**             | On‑board Octal PSRAM for graphics buffers       |
| **Buttons**           | RESET and BOOT (flash) buttons                  |
| **Operating voltage** | 5 V (4 V – 5.25 V via USB‑C)                    |
| **Environmental**     | −40 °C – +85 °C                                 |

The board also supports **Arduino** and **MicroPython** development, but this example focuses on **ESP‑IDF**.

## Features

The ESP‑IDF version replicates the functionality of Makerfabs’ Arduino examples while leveraging FreeRTOS tasks and native drivers:

- **LCD driver (ST7701)** — initializes the 480×480 IPS display and provides functions for pixel writes, fills and basic graphics.
- **Touch driver (CST826)** — reads touch coordinates via I²C and provides event callbacks.
- **FreeRTOS tasks** — separates display updates, touch handling and application logic into independent tasks.
- **Example applications**:
  - **Factory test** — displays color patterns, ring encoder values and touch positions (equivalent to `fw_test` and `fw_test_v2` in the Arduino version).
  - **SPIFFS image viewer** — demonstrates file loading from SPIFFS and JPEG decoding (adapted from `fs_test`).
  - **Stepper control** — controls a stepper motor’s speed and direction using the rotary encoder and display feedback.

Feel free to extend or adapt these examples to suit your own projects.

## Repository structure

```
├── .devcontainer/                     # Container configuration for development
├── .vscode/                           # VS Code editor settings
├── build/                             # Build output directory
├── hello_wrld_screen_lvgl_touch/      # Example application using LVGL and touch
│   ├── inc/
│   │   └── lv_conf.h                  # LVGL configuration header
│   ├── src/                           # LVGL UI and application source files
│   │   ├── actions.h                  # Action callbacks
│   │   ├── fonts.h                    # Font definitions
│   │   ├── images.c
│   │   ├── images.h
│   │   ├── screens.c
│   │   ├── screens.h
│   │   ├── structs.h
│   │   ├── styles.c
│   │   ├── styles.h
│   │   ├── test.eez-project           # GUI project definition
│   │   ├── test.eez-project-ui-state
│   │   ├── ui.c                       # LVGL user interface implementation
│   │   ├── ui.h
│   │   └── vars.h                     # Global variables
│   ├── CMakeLists.txt                 # CMake configuration for the example
│   ├── hello_world_main.c             # Entry point; sets up tasks and peripherals
│   └── idf_component.yml              # Component manifest for ESP‑IDF
├── managed_components/                # Pre‑downloaded component packages
│   ├── espressif_cmake_utilities/
│   ├── espressif_esp_io_expander/
│   ├── espressif_esp_lcd_panel_io_addition/
│   ├── espressif_esp_lcd_st7701/
│   └── lvgl_lvgl/
├── .gitignore
├── CMakeLists.txt                     # Top‑level build configuration
├── dependencies.lock                  # Locked dependencies for managed components
├── pytest_hello_world.py              # Test script
├── README.md                          # Project documentation (this file)
├── sdkconfig                          # ESP‑IDF configuration
├── sdkconfig.ci                       # Configuration for CI builds
└── sdkconfig.old                      # Backup of previous configuration
```

*Note:* the actual file names may vary depending on your implementation.  If your repository is currently empty, use this structure as a suggestion for organizing your ESP‑IDF project.


If you maintain a `components.yml` file to manage your ESP‑IDF components, you can include your drivers and third‑party libraries there to simplify dependency management.  Refer to the original repository and your own `components.yml` for details.

## Getting started

### Prerequisites

- **ESP‑IDF v5.0 or later**: follow the [official installation guide](https://docs.espressif.com/projects/esp-idf/en/latest/esp32s3/get-started/index.html) to set up the toolchain and environment variables.
- **Python 3** and the ESP‑IDF Python requirements (installed via `idf.py install`).
- **USB‑C cable** to connect the MaTouch board to your PC.

### Cloning the repository

```sh
git clone https://github.com/Sivashan108/MaTouch-ESP32-S3-Touch-2.1-ESPIDF_Example.git
cd MaTouch-ESP32-S3-Touch-2.1-ESPIDF_Example
git submodule update --init --recursive  # if using submodules for components
```

### Building the project

1. Set up the ESP‑IDF environment:

   ```sh
   . $IDF_PATH/export.sh
   ```

2. Configure the project (optional):

   ```sh
   idf.py menuconfig
   ```

   Here you can set UART port, PSRAM settings and any application‑specific options.

3. Build and flash the firmware:

   ```sh
   idf.py -p /dev/ttyUSB0 build flash monitor
   ```

   Replace `/dev/ttyUSB0` with the serial port your board appears on (e.g. `COM3` on Windows).

### Installing components

This example depends on several driver components.  You can obtain them from the original Arduino project or implement your own versions.  The typical steps are:

1. **LCD driver** — copy or clone the ST7701 driver sources (`lcd_st7701.c`, `lcd_st7701.h`, etc.) into a component directory such as `components/lcd_st7701`.
2. **Touch driver** — copy or clone the CST826 touch driver sources into `components/touch_cst826`.
3. **JPEG decoder (optional)** — to display JPEG images, include the [`JPEGDEC` library](https://github.com/bitbank2/JPEGDEC).  You can add it as another component or integrate its source into your project.
4. **LVGL support (optional)** — if you plan to use a GUI library such as LVGL, copy the modified `mf_Lvgl` library from Makerfabs into a `components/mf_lvgl` directory.  Alternatively, add [LVGL](https://github.com/lvgl/lvgl) as a submodule and configure it via `menuconfig`.

After adding or cloning these libraries, update your top‑level `CMakeLists.txt` to include them.  If you use Git submodules for components, run `git submodule update --init --recursive` after cloning the repository.

### Running the examples

After flashing, the device will reset and run `app_main()`.  Depending on which example you selected (factory test, SPIFFS viewer, stepper control), you should see:

- Color test patterns and touch coordinates on the display.
- JPEG images cycling from SPIFFS storage; use the rotary encoder to switch images.
- Stepper motor motion controlled by the encoder and displayed on screen.

Use the serial monitor (`idf.py monitor`) to view debug logs and touch data.

### Example: hello_wrld_screen_lvgl_touch

One of the provided applications, located in `hello_wrld_screen_lvgl_touch/`, demonstrates how to combine the rotary encoder, push‑button and touch input with a simple user interface.  When the firmware boots you will see a yellow circular background with text and a touch button, as shown below:

<img src="images\hello.jpg" alt="drawing" width="200"/>

The example illustrates several interactive behaviors:

- **Button press detection:** The label at the top toggles between “Button Released” and “Button Pressed” when you push the encoder’s built‑in button.  This uses a GPIO interrupt to detect presses and updates the text on screen via LVGL.
- **Encoder position tracking:** Rotating the encoder clockwise increments the **Encoder Position** counter displayed on the screen, while rotating it anticlockwise decrements the counter.  The code reads the quadrature signals with the pulse counter (`pcnt`) peripheral and updates the on‑screen value dynamically.
- **Touch input toggle:** The blue **Touch Me** button at the bottom toggles between blue and red each time you tap it.  LVGL’s button widget handles the press event and the callback function switches the background color to provide visual feedback.

This example serves as a starting point for building more complex interfaces.  You can inspect the source files in `hello_wrld_screen_lvgl_touch/src/` to see how LVGL widgets are defined, how event callbacks are registered and how hardware inputs are integrated into the user interface.

## Porting notes

Porting the Arduino examples to ESP‑IDF involved several key changes:

1. **Driver abstraction** — Arduino libraries for ST7701 and CST826 were rewritten as ESP‑IDF components using the SPI Master and I2C HAL drivers.
2. **Task‑based concurrency** — long‑running loops were converted into FreeRTOS tasks to keep the system responsive.  For example, the display refresh runs in its own task while the main loop handles input.
3. **File system** — Arduino’s SPIFFS support is replaced with ESP‑IDF’s VFS and `esp_spiffs` API.
4. **Rotary encoder** — handling of the rotary encoder uses the `pcnt` (pulse counter) and GPIO interrupts available in ESP‑IDF.

These changes mean you can integrate the display into more complex ESP‑IDF applications, using multiple tasks, Wi‑Fi or Bluetooth connectivity, and advanced peripherals.

## Contributing

Contributions are welcome!  If you add features (e.g. LVGL integration, additional demos), please open a pull request and describe your changes.  Feel free to open issues for bug reports or enhancement ideas.

## License

Unless otherwise specified, this project inherits the licensing terms of the original Makerfabs Arduino example.  Please consult the original repository for licensing details.  If you intend to release your port under a different license, note it here and include a `LICENSE` file.

## Acknowledgements

Thanks to **Makerfabs** for providing the original example code and hardware.  This port is inspired by their work and aims to help developers use the MaTouch board in native ESP‑IDF projects.
